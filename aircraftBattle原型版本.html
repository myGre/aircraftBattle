<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>飞机大战</title>
</head>
<style>
  * {
    padding: 0;
    margin: 0;
  }

  #root {
    height: 100vh;
    width: 500px;
    background-color: rgb(0, 157, 255);
    position: relative;
    overflow: hidden;
  }

  /* 飞机 */
  .aircraft1 {
    width: 100px;
    height: 68px;
    position: absolute;
    z-index: 10;
    background-image: url('./static/image/aircraft/4号.png');
    background-size: 100%;
    background-repeat: no-repeat;
  }

  /* 子弹盒子样式 */
  .bulletsClass {
    width: 100px;
    height: 15px;
    position: absolute;

  }

  /* 子弹 */
  .bullet {
    position: absolute;
    width: 5px;
    height: 15px;
    background-color: rgb(244, 47, 26);
    border-radius: 20px;
  }

  /* 敌机 */
  #hostileBox {
    position: relative;

  }

  .hostile1 {
    width: 100px;
    height: 73px;
    position: absolute;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: url('./static/image/aircraft/敌机.png') no-repeat;
    background-size: 100%;
  }

  /* .hostile_box .hostile .lifebar {
    width: 50px;
    height: 8px;
    background-color: rgb(0, 231, 0);
    border-radius: 20px;
  } */
</style>

<body>
  <div id="root">
    <button class="stopOrStart">停止</button>
    <!-- 敌机 -->
    <div id="hostileBox">
      <!-- <div class="hostile">
            <div class="lifebar"></div>
          </div> -->
    </div>
    <!-- 飞机 -->
    <div id="aircraftBox">
    </div>
  </div>
  <script>
    // 敌机对象
    ((function () {
      let hostileClass = ['hostile1'];
      function PositionAircraft() {
        this.hostileArrly = []; // 敌机位置数组
        this.hostileElementArrly = []; // 敌机元素数组
        this.hostileClass = hostileClass; // 敌机机型样式
        this.element = document.querySelector('#hostileBox'); // 敌机盒子
        this.timer = '' // 敌机运动
        this.createTimer = '' // 创建敌机

      }
      // 初始化敌机
      PositionAircraft.prototype.init = function (map) {
        this.move(map)
      }
      // 敌机的样式
      PositionAircraft.prototype.setStyle = function (map) {
        let element = this.element
        // 敌机的最大或最小移动范围(出现位置)
        let hostileElement = document.createElement('div')
        const bodyWidth = map.clientWidth
        const bodyHeight = map.clientHeight
        hostileElement.className = this.hostileClass[0];

        element.appendChild(hostileElement)
        // 初始化敌机出现位置
        let left = Math.random() * (bodyWidth - hostileElement.offsetWidth)
        hostileElement.style.top = (-hostileElement.offsetHeight) + 'px';
        hostileElement.style.left = left + 'px';
        this.hostileArrly.push({ top: -hostileElement.offsetHeight, left })
        this.hostileElementArrly.push(hostileElement)
      }
      // 敌机运动轨迹
      PositionAircraft.prototype.move = function (map) {
        const bodyHeight = map.clientHeight
        let hostileElementArrly = this.hostileElementArrly

        // 创建敌机
        this.createTimer = setInterval(() => {
          this.setStyle(map)
        }, 3000)

        // 敌机运动
        this.timer = setInterval(() => {
          this.hostileArrly.forEach((item, index) => {
            let hostileElement = hostileElementArrly[index]
            let difference = hostileElement.offsetHeight / 30
            item.top += difference
            hostileElement.style.top = item.top + 'px'
            if (item.top > bodyHeight) {
              this.hostileArrly.splice(index, 1)
              this.element.removeChild(this.element.children[index])
              this.hostileElementArrly.splice(index, 1)
            }
          });
        }, 50)
      }
      PositionAircraft.prototype.stop = function () {
        clearInterval(this.createTimer)
        clearInterval(this.timer)

      }
      window.PositionAircraft = PositionAircraft;
    }()));
    // 子弹对象
    ((function () {
      let bulletsClass = 'bulletsClass';
      let bulletClass = 'bullet';
      function Bullet() {
        this.bulletsClass = bulletsClass; // 装子弹盒子的样式
        this.bulletClass = bulletClass; // 子弹样式
        this.bullets = []; // 装子弹的数组
        this.bulletsArrElement = []; // 装子弹元素的数组
        this.bulletsLeftOrTop = {} // 子弹盒子当前的位置
        this.number = 3; // 子弹数量
        this.bulletElement = document.createElement('div');
        this.timer = ''; //子弹射击
      }
      // 初始化子弹
      Bullet.prototype.init = function (bulletsLeftOrTop) {
        this.setLeftOrTop(bulletsLeftOrTop)
        this.setBulletNum()
        this.setBullet()
      }
      // 设置子弹盒子当前的位置
      Bullet.prototype.setLeftOrTop = function (bulletsLeftOrTop) {
        let bullets = this.bulletElement;
        this.bulletsLeftOrTop = bulletsLeftOrTop
        let { top, left } = this.bulletsLeftOrTop
      }
      // 设置子弹样式和数量
      Bullet.prototype.setBulletNum = function (number = 2) {
        // this.number = number
        let { top, left } = this.bulletsLeftOrTop
        let bulletElement = this.bulletElement;
        let bullets = document.createElement('div');
        let bulletsArrElement = this.bulletsArrElement
        bullets.className = this.bulletsClass;
        bullets.style.top = top + 'px';
        bullets.style.left = left + 'px';
        let bulletArr = [] // 每发子弹的盒子
        let bulletLeft = null
        let bulletTop = null
        switch (this.number) {
          case 1:
            let bullet = document.createElement('p'); // 每发子弹
            bullet.className = this.bulletClass;

            bulletLeft = left + 48
            bulletTop = top
            bullet.style.left = 48 + 'px'

            bullets.appendChild(bullet)
            bulletArr.push({ bulletLeft, bulletTop })
            // 子弹的初始位置
            this.bullets.push(bulletArr)
            bulletsArrElement.push(bullets)
            bulletElement.appendChild(bullets)
            break;
          case 2:
            for (let i = 0; i < 2; i++) {
              let bullet = document.createElement('p'); // 每发子弹
              bullet.className = this.bulletClass; // 每发子弹的样式
              if (i === 0) {
                bulletLeft = left + 5
                bulletTop = top
                bullet.style.left = 5 + 'px'
              }
              if (i === 1) {
                bulletLeft = left + 89
                bulletTop = top
                bullet.style.left = 89 + 'px'
              }
              bullets.appendChild(bullet)
              bulletArr.push({ bulletLeft, bulletTop })

            }
            this.bullets.push(bulletArr)
            bulletsArrElement.push(bullets)
            bulletElement.appendChild(bullets)
            break;
          case 3:
            for (let i = 0; i < 3; i++) {
              let bullet = document.createElement('p'); // 每发子弹
              bullet.className = this.bulletClass; // 每发子弹的样式
              if (i === 0) {
                bulletLeft = left + 5
                bulletTop = top
                bullet.style.left = 5 + 'px'
              }
              if (i === 1) {
                bulletLeft = left + 48
                bulletTop = top + -10
                bullet.style.left = 48 + 'px'
                bullet.style.top = -10 + 'px'

              }
              if (i === 2) {
                bulletLeft = left + 89
                bulletTop = top
                bullet.style.left = 89 + 'px'
              }
              bullets.appendChild(bullet)
              bulletArr.push({ bulletLeft, bulletTop })
            }
            this.bullets.push(bulletArr)
            bulletsArrElement.push(bullets)
            bulletElement.appendChild(bullets)
            break;
        }

      }
      // 子弹射击
      Bullet.prototype.setBullet = function () {
        this.timer = setInterval(() => {
          let difference = Math.ceil(Math.random() * 10) + 30

          for (let i = 0; i < this.bulletsArrElement.length; i++) {
            const element = this.bulletsArrElement[i];
            element.style.top = this.bullets[i][0].bulletTop - difference + 'px'
            this.bullets[i][0].bulletTop -= difference
            if (this.bullets[i][0].bulletTop < -60) {
              // clearInterval(timer)
              this.bulletElement.removeChild(this.bulletElement.children[i])
              this.bulletsArrElement.shift()
              this.bullets.shift()
            }
          }
          this.setBulletNum(Math.ceil(Math.random() * 3))

        }, 100)
      }
      // 停止射击
      Bullet.prototype.stop = function () {
        clearInterval(this.timer)
      }
      window.Bullet = Bullet;
    })());

    // 飞机对象
    ((function () {
      let aircraftClass = ['aircraft1'];
      function Aircraft() {
        this.aircraftLeftOrTop = { top: 450, left: 200 };
        this.aircraftClass = aircraftClass; // 飞机机型样式
        this.element = document.querySelector('#aircraftBox'); // 整个飞机盒子
        this.aircraftElement = document.createElement('div'); // 飞机
        this.bullet = new Bullet(); // 子弹
        this.flag = false; // 控制飞机是否可以移动
      }
      // 初始化
      Aircraft.prototype.init = function (map) {
        let aircraftBox = this.element
        let aircraftElement = this.aircraftElement
        let bullet = this.bullet
        // 初始化飞机样式
        this.setStyle(aircraftElement)
        // 初始化子弹
        bullet.init(this.aircraftLeftOrTop)

        // 添加到页面
        aircraftBox.appendChild(bullet.bulletElement);
        aircraftBox.appendChild(aircraftElement);

        map.appendChild(aircraftBox);
        console.log('初始化飞机', this);
      }
      // 飞机样式
      Aircraft.prototype.setStyle = function (aircraftElement) {
        aircraftElement.style.top = this.aircraftLeftOrTop.top + 'px';
        aircraftElement.style.left = this.aircraftLeftOrTop.left + 'px';
        aircraftElement.className = this.aircraftClass[0];
      }
      // 飞机移动
      Aircraft.prototype.move = function (aircraftLeftOrTop) {
        let { top, left } = aircraftLeftOrTop
        let aircraft = this.aircraftElement
        let bullet = this.bullet
        if (this.flag) {
          aircraft.style.top = top + 'px'
          aircraft.style.left = left + 'px'
          this.aircraftLeftOrTop.left = left
          this.aircraftLeftOrTop.top = top
          // bullet.setLeftOrTop(this.aircraftLeftOrTop)

        }
      }
      // 停止
      Aircraft.prototype.stop = function () {
        this.bullet.stop()
      }

      window.Aircraft = Aircraft;
    })());

    // 游戏对象
    ((function () {
      function Game() {
        this.aircraft = new Aircraft() // 飞机
        this.positionAircraft = new PositionAircraft() // 敌机
        this.aircraftMousedown = () => { }
      }
      // 初始化游戏
      Game.prototype.init = function (map) {
        console.log('初始化游戏对象', this);
        this.aircraft.init(map)
        this.positionAircraft.init(map)
        this.rouAircraft(map)
      }
      // 触摸移动飞机
      Game.prototype.rouAircraft = function (map) {
        const bodyWidth = map.clientWidth
        const bodyHeight = map.clientHeight
        const aircraft = this.aircraft.aircraftElement

        // 开启飞机跟随鼠标移动
        this.aircraftMousedown = (e) => {
          this.aircraft.flag = true
          // 鼠标按下的位置
          let x = e.offsetX
          let y = e.offsetY
          let aircraftLeftOrTop = {}
          document.addEventListener('mousemove', (e) => {
            // 飞机的最大或最小移动范围
            let _w = bodyWidth - aircraft.offsetWidth
            let _h = bodyHeight - aircraft.offsetHeight

            let left = e.clientX - x
            let top = e.clientY - y
            // 限制飞机移动的范围
            aircraftLeftOrTop.left = Math.min(Math.max(0, left), _w)
            aircraftLeftOrTop.top = Math.min(Math.max(0, top), _h)
            this.aircraft.move(aircraftLeftOrTop)
          })
        }
        aircraft.addEventListener('mousedown', this.aircraftMousedown)

        // 关闭飞机跟随鼠标移动
        aircraft.addEventListener('mouseup', (e) => {
          this.aircraft.flag = false
        })
        document.addEventListener('mouseup', () => {
          this.aircraft.flag = false
        })
      }
      // 停止游戏
      Game.prototype.stop = function () {
        this.aircraft.stop()
        this.positionAircraft.stop()
        const aircraft = this.aircraft.aircraftElement
        aircraft.removeEventListener('mousedown', this.aircraftMousedown)
      }
      // 开始游戏
      Game.prototype.start = function (map) {
        this.aircraft.init(map)
        this.positionAircraft.init(map)
        this.rouAircraft(map)
      }
      window.Game = Game
    })());
    const map = document.querySelector('#root') // 整个页面
    const stopOrStart = document.querySelector('.stopOrStart') //停止或开始游戏

    // 开启游戏
    let game = new Game()
    game.init(map)
    stopOrStart.addEventListener('click', (e) => {
      if (stopOrStart.innerHTML == '停止') {
        game.stop()
        stopOrStart.innerHTML = '继续'
      } else if (stopOrStart.innerHTML == '继续') {
        game.start(map)
        stopOrStart.innerHTML = '停止'

      }
    })

  </script>
</body>

</html>